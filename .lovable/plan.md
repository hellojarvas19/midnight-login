

# Backend Step 1: Authentication and User Profiles

We'll set up Lovable Cloud (Supabase) and build real user authentication as the foundation for everything else.

---

## What This Step Covers

1. **Enable Lovable Cloud** to get a database and auth system
2. **Create a profiles table** to store user info (username, avatar, Telegram ID, credits, referral data)
3. **Create a user_roles table** for role management (admin/user)
4. **Set up Telegram-style authentication** using Supabase email/password auth (Telegram OAuth requires a bot token and external webhook -- we can layer that on later, but for now we'll use a login form that fits the existing UI)
5. **Protect the dashboard** so only logged-in users can access it
6. **Wire up the Profile page** to show real user data instead of mock data

---

## Database Schema

### `profiles` table
| Column | Type | Notes |
|--------|------|-------|
| id | uuid (PK, FK to auth.users) | |
| username | text | Display name |
| telegram_id | text (nullable) | For future Telegram integration |
| avatar_url | text (nullable) | |
| credits | integer (default 0) | |
| referral_code | text (unique) | Auto-generated |
| referred_by | uuid (nullable, FK to profiles) | |
| created_at | timestamptz | |

### `user_roles` table
| Column | Type | Notes |
|--------|------|-------|
| id | uuid (PK) | |
| user_id | uuid (FK to auth.users, CASCADE) | |
| role | app_role enum (admin, moderator, user) | |
| unique(user_id, role) | | |

### RLS Policies
- Users can read their own profile
- Users can update their own profile (username, avatar_url only)
- Roles table secured with a `has_role()` security definer function

### Trigger
- Auto-create profile row on signup with a generated referral code

---

## File Changes

### New Files
- **`src/integrations/supabase/client.ts`** -- Supabase client (auto-generated by Lovable Cloud)
- **`src/contexts/AuthContext.tsx`** -- Auth provider with `onAuthStateChange` listener, exposes `user`, `profile`, `signIn`, `signUp`, `signOut`
- **`src/pages/ResetPassword.tsx`** -- Password reset page (required for forgot-password flow)

### Modified Files
- **`src/App.tsx`** -- Wrap with `AuthProvider`, add `/reset-password` route, protect `/dashboard` with auth guard
- **`src/components/AuthCard.tsx`** -- Replace "Continue with Telegram" button with email/password login form (sign in + sign up toggle), keep existing glassmorphism styling
- **`src/pages/Index.tsx`** -- Redirect to `/dashboard` if already logged in
- **`src/pages/Dashboard.tsx`** -- Redirect to `/` if not logged in
- **`src/pages/dashboard/ProfilePage.tsx`** -- Replace `MOCK_USER` with real profile data from `AuthContext`; wire logout to `supabase.auth.signOut()`

---

## Implementation Order
1. Enable Lovable Cloud
2. Create migration: profiles table, user_roles table, enum, has_role function, RLS policies, trigger
3. Create AuthContext with session management
4. Update AuthCard with login/signup form
5. Add route protection (auth guard)
6. Wire ProfilePage to real data
7. Add ResetPassword page

This gives us a solid foundation. After this, we'll move on to **Step 2: Real-time Chat** with persistent messages.

